const express = require('express');
const cors = require('cors');
const { sequelize } = require('./config/database');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 5000;

// Middleware
app.use(cors());
app.use(express.json());

// Import models from models/index.js
const { User, Service, Ticket, Counter } = require('./models');

// Test database connection
sequelize.authenticate()
  .then(() => console.log('âœ… Connected to SQLite database'))
  .catch(err => console.log('âŒ Database connection error:', err.message));

// ==================== ROUTES ====================

// Home route
app.get('/', (req, res) => {
  res.json({
    project: "ğŸ¦ Bank Queue Management System",
    version: "1.0.0",
    status: "âœ… Online",
    database: "SQLite (Active)",
    endpoints: {
      home: "/",
      health: "/health",
      test_models: "/api/test/models",
      services: "/api/services",
      counters: "/api/counters",
      status: "/api/status"
    },
    timestamp: new Date().toISOString()
  });
});

// Health check
app.get('/health', async (req, res) => {
  try {
    await sequelize.authenticate();
    res.json({
      status: 'healthy',
      server_time: new Date().toISOString(),
      uptime: process.uptime(),
      database: 'connected',
      environment: process.env.NODE_ENV
    });
  } catch (error) {
    res.status(500).json({
      status: 'unhealthy',
      error: error.message,
      database: 'disconnected'
    });
  }
});

// Test database models
app.get('/api/test/models', async (req, res) => {
  try {
    console.log('ğŸ” Testing database models...');
    
    const userCount = await User.count();
    const serviceCount = await Service.count();
    const counterCount = await Counter.count();
    const ticketCount = await Ticket.count();
    
    res.json({
      success: true,
      message: 'âœ… Database models are working!',
      counts: {
        users: userCount,
        services: serviceCount,
        counters: counterCount,
        tickets: ticketCount
      },
      models_loaded: ['User', 'Service', 'Ticket', 'Counter'],
      test_credentials: {
        admin: 'admin@bank.com / password123',
        client: 'client1@example.com / password123'
      }
    });
  } catch (error) {
    console.error('âŒ Error testing models:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// List all services
app.get('/api/services', async (req, res) => {
  try {
    const services = await Service.findAll({
      where: { is_active: true },
      attributes: ['id', 'code', 'name', 'description', 'estimated_time']
    });
    
    res.json({
      success: true,
      count: services.length,
      services
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// List all counters
app.get('/api/counters', async (req, res) => {
  try {
    const counters = await Counter.findAll({
      include: [{
        model: User,
        as: 'employee',
        attributes: ['id', 'first_name', 'last_name', 'email']
      }],
      attributes: ['id', 'number', 'name', 'status', 'services', 'location']
    });
    
    res.json({
      success: true,
      count: counters.length,
      counters
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// API status
app.get('/api/status', (req, res) => {
  res.json({
    system: 'Bank Queue System',
    status: 'Operational',
    message: 'API is working correctly',
    database: 'SQLite',
    models_loaded: ['User', 'Service', 'Ticket', 'Counter']
  });
});

// ==================== START SERVER ====================

// Sync database and start server
sequelize.sync({ force: false })
  .then(() => {
    console.log('âœ… Database tables synchronized');
    
    app.listen(PORT, () => {
      console.log('='.repeat(60));
      console.log('ğŸ¦ BANK QUEUE MANAGEMENT SYSTEM');
      console.log('='.repeat(60));
      console.log(`âœ… Server: http://localhost:${PORT}`);
      console.log(`âœ… Health: http://localhost:${PORT}/health`);
      console.log(`âœ… Test models: http://localhost:${PORT}/api/test/models`);
      console.log(`âœ… Services: http://localhost:${PORT}/api/services`);
      console.log(`âœ… Counters: http://localhost:${PORT}/api/counters`);
      console.log(`ğŸ’¾ Database: ${process.env.DB_STORAGE}`);
      console.log(`âš¡ Environment: ${process.env.NODE_ENV}`);
      console.log('='.repeat(60));
      console.log('ğŸš€ Ready for development!');
      console.log('='.repeat(60));
    });
  })
  .catch(err => {
    console.error('âŒ Failed to sync database:', err);
    process.exit(1);
  });
